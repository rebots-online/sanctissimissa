<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SanctissiMissa SQLite Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <header class="bg-gray-800 text-white p-4 rounded-lg mb-6">
      <h1 class="text-2xl font-bold">SanctissiMissa SQLite Demo</h1>
      <p class="text-gray-300">A simple demonstration of SQLite functionality</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Database Status</h2>
        <div id="status" class="p-4 bg-gray-100 rounded">
          <p>Initializing database...</p>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Actions</h2>
        <div class="space-y-2">
          <button id="btnLiturgicalDays" class="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50" disabled>
            View Liturgical Days
          </button>
          <button id="btnMassTexts" class="px-4 py-2 bg-green-500 text-white rounded disabled:opacity-50" disabled>
            View Mass Texts
          </button>
          <button id="btnOfficeTexts" class="px-4 py-2 bg-purple-500 text-white rounded disabled:opacity-50" disabled>
            View Office Texts
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Today's Liturgical Day</h2>
        <div id="todayLiturgical" class="p-4 bg-gray-100 rounded">
          <p>Loading data...</p>
        </div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-xl font-bold mb-4">Easter Sunday 2025</h2>
        <div id="easterSunday" class="p-4 bg-gray-100 rounded">
          <p>Loading data...</p>
        </div>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-bold mb-4">Results</h2>
      <div id="results" class="p-4 bg-gray-100 rounded overflow-auto max-h-96">
        <p>Click a button to view data.</p>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let SQL;
    let db;
    let isInitialized = false;

    // Initialize SQL.js
    async function initSqlite() {
      try {
        // Update status
        document.getElementById('status').innerHTML = '<p class="text-blue-500">Loading SQL.js...</p>';

        // Initialize SQL.js
        SQL = await initSqlJs({
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });

        document.getElementById('status').innerHTML += '<p class="text-green-500">SQL.js loaded successfully!</p>';

        // Load the database file
        document.getElementById('status').innerHTML += '<p class="text-blue-500">Loading database file...</p>';

        const response = await fetch('./sanctissimissa.sqlite');
        if (!response.ok) {
          throw new Error(`Failed to fetch database: ${response.statusText}`);
        }

        const arrayBuffer = await response.arrayBuffer();
        const uInt8Array = new Uint8Array(arrayBuffer);

        // Create a database from the file
        db = new SQL.Database(uInt8Array);
        isInitialized = true;

        document.getElementById('status').innerHTML += '<p class="text-green-500">Database loaded successfully!</p>';

        // Enable buttons
        document.getElementById('btnLiturgicalDays').disabled = false;
        document.getElementById('btnMassTexts').disabled = false;
        document.getElementById('btnOfficeTexts').disabled = false;

        // Load liturgical data
        loadTodayLiturgical();
        loadEasterSunday();
      } catch (error) {
        document.getElementById('status').innerHTML += `<p class="text-red-500">Error: ${error.message}</p>`;
        console.error('Error initializing SQLite:', error);
      }
    }

    // Load Easter Sunday data
    function loadEasterSunday() {
      try {
        // Query the database for Easter Sunday
        const result = db.exec("SELECT * FROM liturgical_days WHERE date = '2025-04-20'");

        if (result.length > 0 && result[0].values.length > 0) {
          const easterSunday = {};

          // Map column names to values
          for (let i = 0; i < result[0].columns.length; i++) {
            easterSunday[result[0].columns[i]] = result[0].values[0][i];
          }

          // Display the data
          document.getElementById('easterSunday').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p><strong>Date:</strong> ${easterSunday.date}</p>
                <p><strong>Celebration:</strong> ${easterSunday.celebration}</p>
                <p><strong>Season:</strong> ${easterSunday.season}</p>
                <p><strong>Color:</strong> ${easterSunday.color}</p>
              </div>
              <div>
                <p><strong>Rank:</strong> ${easterSunday.rank}</p>
                <p><strong>Holy Day:</strong> ${easterSunday.is_holy_day ? 'Yes' : 'No'}</p>
                <p><strong>Feast Day:</strong> ${easterSunday.is_feast_day ? 'Yes' : 'No'}</p>
                <p><strong>Mass Proper:</strong> ${easterSunday.mass_proper}</p>
              </div>
            </div>
          `;
        } else {
          document.getElementById('easterSunday').innerHTML = '<p class="text-red-500">Easter Sunday data not found.</p>';
        }
      } catch (error) {
        document.getElementById('easterSunday').innerHTML = `<p class="text-red-500">Error loading Easter Sunday data: ${error.message}</p>`;
        console.error('Error loading Easter Sunday data:', error);
      }
    }

    // View liturgical days
    document.getElementById('btnLiturgicalDays').addEventListener('click', function() {
      try {
        const result = db.exec("SELECT * FROM liturgical_days ORDER BY date LIMIT 10");

        if (result.length > 0) {
          let html = '<table class="min-w-full bg-white">';

          // Table header
          html += '<thead><tr>';
          for (const column of result[0].columns) {
            html += `<th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${column}</th>`;
          }
          html += '</tr></thead>';

          // Table body
          html += '<tbody>';
          for (const row of result[0].values) {
            html += '<tr>';
            for (const cell of row) {
              html += `<td class="py-2 px-4 border-b border-gray-200">${cell}</td>`;
            }
            html += '</tr>';
          }
          html += '</tbody></table>';

          document.getElementById('results').innerHTML = html;
        } else {
          document.getElementById('results').innerHTML = '<p class="text-red-500">No liturgical days found.</p>';
        }
      } catch (error) {
        document.getElementById('results').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        console.error('Error querying liturgical days:', error);
      }
    });

    // View mass texts
    document.getElementById('btnMassTexts').addEventListener('click', function() {
      try {
        const result = db.exec("SELECT id, part, title_latin, title_english FROM mass_texts");

        if (result.length > 0) {
          let html = '<table class="min-w-full bg-white">';

          // Table header
          html += '<thead><tr>';
          for (const column of result[0].columns) {
            html += `<th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${column}</th>`;
          }
          html += '</tr></thead>';

          // Table body
          html += '<tbody>';
          for (const row of result[0].values) {
            html += '<tr>';
            for (const cell of row) {
              html += `<td class="py-2 px-4 border-b border-gray-200">${cell}</td>`;
            }
            html += '</tr>';
          }
          html += '</tbody></table>';

          document.getElementById('results').innerHTML = html;
        } else {
          document.getElementById('results').innerHTML = '<p class="text-red-500">No mass texts found.</p>';
        }
      } catch (error) {
        document.getElementById('results').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        console.error('Error querying mass texts:', error);
      }
    });

    // View office texts
    document.getElementById('btnOfficeTexts').addEventListener('click', function() {
      try {
        const result = db.exec("SELECT id, hour, title_latin, title_english FROM office_texts");

        if (result.length > 0) {
          let html = '<table class="min-w-full bg-white">';

          // Table header
          html += '<thead><tr>';
          for (const column of result[0].columns) {
            html += `<th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">${column}</th>`;
          }
          html += '</tr></thead>';

          // Table body
          html += '<tbody>';
          for (const row of result[0].values) {
            html += '<tr>';
            for (const cell of row) {
              html += `<td class="py-2 px-4 border-b border-gray-200">${cell}</td>`;
            }
            html += '</tr>';
          }
          html += '</tbody></table>';

          document.getElementById('results').innerHTML = html;
        } else {
          document.getElementById('results').innerHTML = '<p class="text-red-500">No office texts found.</p>';
        }
      } catch (error) {
        document.getElementById('results').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        console.error('Error querying office texts:', error);
      }
    });

    // Calculate Easter Sunday date for a given year
    function calculateEaster(year) {
      // Algorithm from Butcher's Ecclesiastical Calendar
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;

      return new Date(year, month - 1, day);
    }

    // Load today's liturgical day
    function loadTodayLiturgical() {
      try {
        // Get today's date
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;

        // Calculate Easter Sunday for this year
        const easterSunday = calculateEaster(year);

        // Format Easter Sunday date as YYYY-MM-DD
        const easterYear = easterSunday.getFullYear();
        const easterMonth = String(easterSunday.getMonth() + 1).padStart(2, '0');
        const easterDay = String(easterSunday.getDate()).padStart(2, '0');
        const easterDateString = `${easterYear}-${easterMonth}-${easterDay}`;

        // Calculate days since Easter
        const todayTime = today.getTime();
        const easterTime = easterSunday.getTime();
        const daysSinceEaster = Math.floor((todayTime - easterTime) / (1000 * 60 * 60 * 24));

        // Traditional liturgical colors
        const colorMap = {
          'white': 'White/Gold (Albus/Aureus)',
          'red': 'Red (Ruber)',
          'green': 'Green (Viridis)',
          'purple': 'Purple/Violet (Violaceus)',
          'black': 'Black (Niger)',
          'rose': 'Rose (Rosaceus)'
        };

        // Query the database for today's date
        const result = db.exec(`SELECT * FROM liturgical_days WHERE date = '${dateString}'`);

        if (result.length > 0 && result[0].values.length > 0) {
          // We have an entry for today in the database
          const liturgicalDay = {};

          // Map column names to values
          for (let i = 0; i < result[0].columns.length; i++) {
            liturgicalDay[result[0].columns[i]] = result[0].values[0][i];
          }

          // Get the mass proper
          let massProperInfo = '';
          if (liturgicalDay.mass_proper) {
            const massResult = db.exec(`SELECT title_latin, title_english FROM mass_texts WHERE id = '${liturgicalDay.mass_proper}'`);
            if (massResult.length > 0 && massResult[0].values.length > 0) {
              massProperInfo = `${massResult[0].values[0][0]} / ${massResult[0].values[0][1]}`;
            }
          }

          // Display the data
          document.getElementById('todayLiturgical').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p><strong>Date:</strong> ${liturgicalDay.date}</p>
                <p><strong>Celebration:</strong> ${liturgicalDay.celebration}</p>
                <p><strong>Season:</strong> ${liturgicalDay.season}</p>
                <p><strong>Color:</strong> ${colorMap[liturgicalDay.color] || liturgicalDay.color}</p>
              </div>
              <div>
                <p><strong>Rank:</strong> ${liturgicalDay.rank}</p>
                <p><strong>Holy Day:</strong> ${liturgicalDay.is_holy_day ? 'Yes' : 'No'}</p>
                <p><strong>Feast Day:</strong> ${liturgicalDay.is_feast_day ? 'Yes' : 'No'}</p>
                <p><strong>Mass Proper:</strong> ${massProperInfo || liturgicalDay.mass_proper || 'N/A'}</p>
              </div>
            </div>
          `;
        } else {
          // No entry in database, calculate based on Easter
          let liturgicalInfo = '';

          if (daysSinceEaster === 0) {
            liturgicalInfo = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p><strong>Date:</strong> ${dateString}</p>
                  <p><strong>Celebration:</strong> Easter Sunday</p>
                  <p><strong>Season:</strong> Easter</p>
                  <p><strong>Color:</strong> ${colorMap['white']}</p>
                </div>
                <div>
                  <p><strong>Rank:</strong> 1</p>
                  <p><strong>Holy Day:</strong> Yes</p>
                  <p><strong>Feast Day:</strong> Yes</p>
                  <p><strong>Mass Proper:</strong> Dominica Resurrectionis / Easter Sunday</p>
                </div>
              </div>
            `;
          } else if (daysSinceEaster > 0 && daysSinceEaster <= 7) {
            // Easter Week (Octave of Easter)
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Low Sunday'];
            const dayName = dayNames[daysSinceEaster - 1];

            liturgicalInfo = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p><strong>Date:</strong> ${dateString}</p>
                  <p><strong>Celebration:</strong> Easter ${dayName}</p>
                  <p><strong>Season:</strong> Easter</p>
                  <p><strong>Color:</strong> ${colorMap['white']}</p>
                </div>
                <div>
                  <p><strong>Rank:</strong> ${daysSinceEaster === 7 ? '2' : '1'}</p>
                  <p><strong>Holy Day:</strong> ${daysSinceEaster === 7 ? 'No' : 'Yes'}</p>
                  <p><strong>Feast Day:</strong> Yes</p>
                  <p><strong>Mass Proper:</strong> ${daysSinceEaster === 7 ? 'Dominica in Albis / Low Sunday' : `Feria ${daysSinceEaster} Paschae / Easter ${dayName}`}</p>
                </div>
              </div>
            `;
          } else if (daysSinceEaster > 7 && daysSinceEaster < 50) {
            // Easter Season (up to Pentecost)
            const weekNumber = Math.floor((daysSinceEaster - 1) / 7) + 1;
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            liturgicalInfo = `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p><strong>Date:</strong> ${dateString}</p>
                  <p><strong>Celebration:</strong> ${dayOfWeek === 0 ? `${weekNumber + 1}nd Sunday after Easter` : `${dayNames[dayOfWeek]} of the ${weekNumber + 1}nd week after Easter`}</p>
                  <p><strong>Season:</strong> Easter</p>
                  <p><strong>Color:</strong> ${colorMap['white']}</p>
                </div>
                <div>
                  <p><strong>Rank:</strong> ${dayOfWeek === 0 ? '2' : '4'}</p>
                  <p><strong>Holy Day:</strong> No</p>
                  <p><strong>Feast Day:</strong> ${dayOfWeek === 0 ? 'Yes' : 'No'}</p>
                  <p><strong>Mass Proper:</strong> ${dayOfWeek === 0 ? `Dominica ${weekNumber + 1} post Pascha / ${weekNumber + 1}nd Sunday after Easter` : 'Feria Temporis Paschalis / Ferial day in Eastertide'}</p>
                </div>
              </div>
            `;
          } else {
            // Not Easter season, show a generic message
            liturgicalInfo = `
              <p class="text-amber-600">No specific liturgical day found for today (${dateString}).</p>
              <p class="mt-2">Easter Sunday this year is on ${easterDateString}.</p>
              <p class="mt-2">Days since Easter: ${daysSinceEaster}</p>
              <p class="mt-2">In a complete implementation, the traditional calendar would include:</p>
              <ul class="list-disc pl-5 mt-2">
                <li>Temporal cycle (Sundays and weekdays)</li>
                <li>Sanctoral cycle (Saints' feasts)</li>
                <li>Moveable feasts</li>
                <li>Proper ranking and precedence rules</li>
              </ul>
            `;
          }

          document.getElementById('todayLiturgical').innerHTML = liturgicalInfo;
        }
      } catch (error) {
        document.getElementById('todayLiturgical').innerHTML = `<p class="text-red-500">Error loading today's liturgical data: ${error.message}</p>`;
        console.error('Error loading today\'s liturgical data:', error);
      }
    }

    // Initialize the application
    initSqlite();
  </script>
</body>
</html>
