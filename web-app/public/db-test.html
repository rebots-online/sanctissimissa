<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLite Database Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    pre {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
    }
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    .error {
      color: #dc3545;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .success {
      color: #28a745;
      background-color: #d4edda;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .query-box {
      width: 100%;
      height: 100px;
      font-family: monospace;
      margin-bottom: 10px;
      padding: 10px;
    }
    .results {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>SQLite Database Test</h1>
  
  <div id="status">Loading SQL.js...</div>
  
  <div style="margin-top: 20px;">
    <h2>Run SQL Query</h2>
    <textarea id="query" class="query-box">SELECT name FROM sqlite_master WHERE type='table';</textarea>
    <button id="runQuery">Run Query</button>
  </div>
  
  <div class="results" id="results"></div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script>
    let db = null;
    
    // Initialize SQL.js and load the database
    async function initDb() {
      try {
        // Initialize SQL.js
        const SQL = await initSqlJs({
          locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        });
        
        document.getElementById('status').innerHTML = '<div class="success">SQL.js loaded successfully</div>';
        
        // Load the database file
        const response = await fetch('/sanctissimissa.sqlite');
        if (!response.ok) {
          throw new Error(`Failed to fetch database: ${response.statusText}`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const uInt8Array = new Uint8Array(arrayBuffer);
        
        // Create a database from the file
        db = new SQL.Database(uInt8Array);
        document.getElementById('status').innerHTML += '<div class="success">Database loaded successfully</div>';
        
        // Show database tables
        const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table';");
        let tableHtml = '<h3>Database Tables:</h3><ul>';
        
        if (tables.length > 0 && tables[0].values.length > 0) {
          for (const row of tables[0].values) {
            tableHtml += `<li>${row[0]}</li>`;
          }
        } else {
          tableHtml += '<li>No tables found</li>';
        }
        
        tableHtml += '</ul>';
        document.getElementById('results').innerHTML = tableHtml;
        
      } catch (error) {
        document.getElementById('status').innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Error initializing database:', error);
      }
    }
    
    // Run a custom SQL query
    function runQuery() {
      if (!db) {
        document.getElementById('results').innerHTML = '<div class="error">Database not loaded yet</div>';
        return;
      }
      
      const query = document.getElementById('query').value.trim();
      if (!query) {
        document.getElementById('results').innerHTML = '<div class="error">Please enter a SQL query</div>';
        return;
      }
      
      try {
        const result = db.exec(query);
        
        if (result.length === 0) {
          document.getElementById('results').innerHTML = '<div class="success">Query executed successfully (no results returned)</div>';
          return;
        }
        
        let resultHtml = '<h3>Query Results:</h3>';
        
        for (const res of result) {
          // Create a table for the results
          resultHtml += '<table border="1" cellpadding="5" style="border-collapse: collapse; width: 100%;">';
          
          // Table header
          resultHtml += '<thead><tr>';
          for (const column of res.columns) {
            resultHtml += `<th>${column}</th>`;
          }
          resultHtml += '</tr></thead>';
          
          // Table body
          resultHtml += '<tbody>';
          for (const row of res.values) {
            resultHtml += '<tr>';
            for (const cell of row) {
              resultHtml += `<td>${cell === null ? 'NULL' : cell}</td>`;
            }
            resultHtml += '</tr>';
          }
          resultHtml += '</tbody></table>';
        }
        
        document.getElementById('results').innerHTML = resultHtml;
        
      } catch (error) {
        document.getElementById('results').innerHTML = `<div class="error">Error executing query: ${error.message}</div>`;
        console.error('Error executing query:', error);
      }
    }
    
    // Initialize the database when the page loads
    window.addEventListener('DOMContentLoaded', initDb);
    
    // Set up the run query button
    document.getElementById('runQuery').addEventListener('click', runQuery);
  </script>
</body>
</html>
